
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if the user is an admin
    function isAdmin() {
      // In a real app, use custom claims for roles: request.auth.token.admin == true
      return request.auth != null && request.auth.token.email == 'hagaaty@gmail.com';
    }

    // Helper function to check which fields are being updated
    function isUpdatingAllowedFields() {
      // List of fields that CANNOT be updated directly by the user.
      let protectedFields = ['balance', 'adBalance', 'totalSpent', 'rank', 'affiliateEarnings', 'referralsCount', 'affiliateLevel', 'apiKey', 'referralCode', 'referrerId', 'createdAt'];
      // Check if any of the incoming data keys are in the protected list.
      return !request.resource.data.keys().hasAny(protectedFields);
    }
    
    // Users can read their own profile. Writes are more restricted.
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      // Allow creation of own user document (during signup fallback)
      allow create: if isOwner(userId);
      // Allow updates to non-sensitive fields by the user directly.
      // Sensitive fields must only be updated via server-side logic (transactions).
      allow update: if isOwner(userId) && isUpdatingAllowedFields();
    }
    
    // Admins can manage all user documents
    match /users/{userId} {
        allow read, write: if isAdmin();
    }

    // Services are publicly readable, but only admins can write.
    match /services/{serviceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Users can manage their own orders. Admins have full access.
    match /users/{userId}/orders/{orderId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // Users can manage their own campaigns. Admins have full access.
    match /users/{userId}/campaigns/{campaignId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // Users can manage their own deposits. Admins have full access.
    match /users/{userId}/deposits/{depositId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // Users can read their own affiliate transactions. Writes are server-side.
    match /users/{userId}/affiliateTransactions/{transactionId} {
      allow read, create: if isOwner(userId);
      allow update, delete: if false; // Transactions are immutable
      allow read, write: if isAdmin(); // Admin override
    }

    // Users can manage their own support tickets. Admins have full access.
    match /users/{userId}/tickets/{ticketId} {
      allow read, create, update, delete: if isOwner(userId) || isAdmin();
    }

    // Blog posts are publicly readable. Writes are restricted to admins.
    match /blogPosts/{blogPostId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Admins can manage global settings
    match /settings/global {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
