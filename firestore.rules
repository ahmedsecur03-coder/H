
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Users can read their own profile, but cannot write to sensitive fields.
    // Writes are handled by server-side logic (transactions).
    match /users/{userId} {
      allow read: if isOwner(userId);
      // Allow creation of own user document (during signup fallback)
      allow create: if isOwner(userId); 
      // Allow updates only to non-sensitive fields
      allow update: if isOwner(userId) && !(request.resource.data.balance != resource.data.balance) && !(request.resource.data.adBalance != resource.data.adBalance) && !(request.resource.data.totalSpent != resource.data.totalSpent) && !(request.resource.data.rank != resource.data.rank) && !(request.resource.data.affiliateEarnings != resource.data.affiliateEarnings);
    }

    // Services are publicly readable, but only admins can write.
    // For now, we disallow all writes until admin logic is fully implemented.
    match /services/{serviceId} {
      allow read: if request.auth != null;
      allow write: if false; // To be replaced with admin check
    }

    // Users can manage their own orders.
    match /users/{userId}/orders/{orderId} {
      allow read, write, delete: if isOwner(userId);
    }

    // Users can manage their own campaigns.
    match /users/{userId}/campaigns/{campaignId} {
      allow read, write, delete: if isOwner(userId);
    }

    // Users can manage their own deposits.
    match /users/{userId}/deposits/{depositId} {
      allow read, write, delete: if isOwner(userId);
    }

    // Users can read their own affiliate transactions. Writes are server-side.
    match /users/{userId}/affiliateTransactions/{transactionId} {
      allow read: if isOwner(userId);
      allow write: if false; // Transactions are created by the system
    }

    // Users can manage their own support tickets.
    match /users/{userId}/tickets/{ticketId} {
      allow read, write, delete: if isOwner(userId);
    }

    // Blog posts are publicly readable. Writes are restricted.
    match /blogPosts/{blogPostId} {
      allow read: if request.auth != null;
      allow write: if false; // To be replaced with admin check
    }
    
    // Fallback rule to deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
