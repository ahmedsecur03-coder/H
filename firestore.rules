
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isCreatingOwnProfile(userId) {
      return isOwner(userId) && request.method == 'create';
    }
    
    function isUpdatingOwnProfile(userId) {
      // Users can only update specific, non-critical fields.
      // They cannot change their rank, balance, totalSpent, etc.
      let modifiableFields = ['name', 'avatarUrl', 'notificationPreferences'];
      return isOwner(userId) 
        && request.method == 'update'
        && request.resource.data.keys().hasOnly(modifiableFields);
    }
    
    function isTransferringBalance(userId) {
      // Users can only decrease their balance and increase their adBalance.
      return isOwner(userId)
        && request.method == 'update'
        && request.resource.data.keys().hasAll(['balance', 'adBalance'])
        && request.resource.data.size() == 2
        && request.resource.data.balance < resource.data.balance;
    }

    // --- Collections ---

    // Users: Users can create their own profile, update a limited set of fields,
    // and transfer funds from their main balance to ad balance. Only the user can read their own profile.
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isCreatingOwnProfile(userId) || isUpdatingOwnProfile(userId) || isTransferringBalance(userId);
    }

    // Services: Publicly readable by all authenticated users. Writable only by admins (not enforced here yet).
    match /services/{serviceId} {
      allow read: if request.auth != null;
      allow write: if false; // To be managed by admin SDK in the future
    }

    // Blog Posts: Publicly readable by all authenticated users. Writable only by admins.
    match /blogPosts/{blogPostId} {
        allow read: if request.auth != null;
        allow write: if false; // To be managed by admin SDK in the future
    }
    
    // Settings: Readable by all authenticated users. Writable only by admins.
    match /settings/global {
        allow read: if request.auth != null;
        allow write: if false; // To be managed by admin SDK in the future
    }

    // System Logs: No client access. Writable only by admin functions.
    match /systemLogs/{logId} {
        allow read, write: if false;
    }


    // --- User-owned Subcollections ---
    // The user must be the owner of the parent user document.

    match /users/{userId}/orders/{orderId} {
      allow read, create, update, delete: if isOwner(userId);
    }
    
    match /users/{userId}/campaigns/{campaignId} {
      allow read, create, update, delete: if isOwner(userId);
    }

    match /users/{userId}/deposits/{depositId} {
      allow read, create, update, delete: if isOwner(userId);
    }
    
    match /users/{userId}/affiliateTransactions/{transactionId} {
      allow read, create, update, delete: if isOwner(userId);
    }

    match /users/{userId}/tickets/{ticketId} {
      allow read, create, update, delete: if isOwner(userId);
    }
  }
}
